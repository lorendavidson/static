<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Distributor Autofill</title>
  <script>
    async function onDistributorChange(e) {
      const distributorID = e.target.value;
      if (!distributorID) return;

      const response = await fetch(`https://script.google.com/macros/s/AKfycbwi0wzpZWvnULord9Iz0Cjg29MA_8b3xck_nYLIwrPY6-5S40ieIHUaYgCgzKMkvhQk/exec?id=${distributorID}`);
      const data = await response.json();

      if (window.parent) {
        window.parent.postMessage({
          type: 'prefillDistributor',
          payload: data
        }, '*');
      }
    }

    function loadDropdown() {
      fetch("https://script.google.com/macros/s/AKfycbwi0wzpZWvnULord9Iz0Cjg29MA_8b3xck_nYLIwrPY6-5S40ieIHUaYgCgzKMkvhQk/exec?list=1")
        .then(res => res.json())
        .then(distributors => {
          const select = document.getElementById("distributorSelect");
          distributors.forEach(d => {
            const option = document.createElement("option");
            option.value = d.ID;
            option.textContent = d.Name;
            select.appendChild(option);
          });
        });
    }

    window.addEventListener("DOMContentLoaded", () => {
      loadDropdown();
      document.getElementById("distributorSelect").addEventListener("change", onDistributorChange);
    });

    window.addEventListener("message", (event) => {
      if (event.data && event.data.type === "debug") {
        console.log("Debug from parent:", event.data.payload);
      }
    });
  </script>
</head>
<body style="margin:0;padding:0;color:#455A64;font-family:sans-serif;">
  <label for="distributorSelect">Choose a Distributor:</label>
  <select id="distributorSelect">
    <option value="">-- Select --</option>
  </select>

  <script>
    window.addEventListener("message", function(event) {
      if (event.data?.type === "prefillDistributor") {
        const { Name, Email } = event.data.payload;
        const iframe = parent.document;

        try {
          const nameField = iframe.querySelector("input[name='wholesaleDistributorName']");
          const emailField = iframe.querySelector("input[name='wholesaleDistributorEmail']");

          if (nameField) nameField.value = Name;
          if (emailField) emailField.value = Email;
        } catch (err) {
          console.error("Error accessing parent form fields:", err);
        }
      }
    });
  </script>
</body>
</html>
